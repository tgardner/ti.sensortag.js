!function(a,b){"use strict";function c(){++g}function d(){--g}var e="00002902-0000-1000-8000-00805f9b34fb",f=function(a){this.device=a,this.services=[],this.Accelerometer=new f.Accelerometer(this),this.IRTemperature=new f.IRTemperature(this),this.Humidity=new f.Humidity(this),this.Magnetometer=new f.Magnetometer(this),this.BarometricPressure=new f.BarometricPressure(this),this.Gyroscope=new f.Gyroscope(this),this.SimpleKey=new f.SimpleKey(this)};f.prototype.log=function(a){console.log("SensorTag #"+this.device+" "+a)},f.prototype.init=function(){for(var a=this,b=0;b<a.services.length;++b){var c=a.services[b];switch(c.uuid){case f.Accelerometer.UUID_SERVICE:a.Accelerometer.init(c);break;case f.IRTemperature.UUID_SERVICE:a.IRTemperature.init(c);break;case f.Humidity.UUID_SERVICE:a.Humidity.init(c);break;case f.Magnetometer.UUID_SERVICE:a.Magnetometer.init(c);break;case f.BarometricPressure.UUID_SERVICE:a.BarometricPressure.init(c);break;case f.Gyroscope.UUID_SERVICE:a.Gyroscope.init(c);break;case f.SimpleKey.UUID_SERVICE:a.SimpleKey.init(c)}}a.log("Initialized")};var g=0;f.prototype.discover=function(a,e){var f=this;f.log("Discovering Services"),c(),evothings.ble.services(f.device,function(c){d(),f.services=c;for(var h=0;h<c.length;++h){var i=c[h];f.discoverCharacteristics(i,a,e)}0===g&&(f.init(),a!==b&&a.call(f))},function(a){d(),f.log("Services error: "+a),e!==b&&e.call(f,a)})},f.prototype.discoverCharacteristics=function(a,e,f){var h=this;c(),evothings.ble.characteristics(h.device,a.handle,function(c){d(),a.characteristics=c;for(var i=0;i<c.length;++i){var j=c[i];h.discoverDescriptors(j,e,f)}0===g&&(h.init(),e!==b&&e.call(h))},function(a){d(),h.log("Characteristics error: "+a),f!==b&&f.call(h,a)})},f.prototype.discoverDescriptors=function(a,e,f){var h=this;c(),evothings.ble.descriptors(h.device,a.handle,function(c){d(),a.descriptors=c,0===g&&(h.init(),e!==b&&e.call(h))},function(a){d(),h.log("Descriptors error: "+a),f!==b&&f.call(h,a)})},f.prototype.close=function(){evothings.ble.close(this.device)},f.SensorBase=function(a,b,c,d){this.identifier="Sensor",this.sensorTag=a,this.UUID_DATA=b,this.UUID_CONF=c,this.UUID_PERIOD=d,this.enabled=!1,this._handles={config:null,period:null,data:null,notification:null},this._listeners=[]},f.SensorBase.prototype.init=function(a){for(var b in a.characteristics){var c=a.characteristics[b];switch(c.uuid){case this.UUID_CONF:this._handles.config=c.handle;break;case this.UUID_PERIOD:this._handles.period=c.handle;break;case this.UUID_DATA:this._handles.data=c.handle;for(var d in c.descriptors){var f=c.descriptors[d];f.uuid==e&&(this._handles.notification=f.handle)}}}},f.SensorBase.prototype.log=function(a){this.sensorTag.log(this.identifier+": "+a)},f.SensorBase.prototype.enable=function(a){var b=1,c=this;evothings.ble.writeCharacteristic(c.sensorTag.device,c._handles.config,new Uint8Array([a||b]),function(){c.enabled=!0},function(a){c.log("enable error: "+a)})},f.SensorBase.prototype.disable=function(){var a=0,b=this;evothings.ble.writeCharacteristic(b.sensorTag.device,b._handles.config,new Uint8Array([a]),function(){b.enabled=!1},function(a){b.log("disable error: "+a)})},f.SensorBase.prototype.enableNotifications=function(){var a=[1,0],b=this;evothings.ble.writeDescriptor(b.sensorTag.device,b._handles.notification,new Uint8Array(a),function(){b.log("Notifications enabled")},function(a){b.log("enableNotifications write error: "+a)}),evothings.ble.enableNotification(b.sensorTag.device,b._handles.data,function(){b.onDataNotify.apply(b,arguments)},function(a){b.log("enableNotifications subscribe error: "+a)})},f.SensorBase.prototype.disableNotification=function(){var a=[0,0],b=this;evothings.ble.writeDescriptor(b.sensorTag.device,b._handles.notification,new Uint8Array(a),function(){b.log("Notifications disabled")},function(a){b.log("disableNotification write error: "+a)}),evothings.ble.disableNotification(b.sensorTag.device,b._handles.data,function(){},function(a){b.log("disableNotification unsubscribe error: "+a)})},f.SensorBase.prototype.addListener=function(a){return this._listeners.push(a),this._listeners.length-1},f.SensorBase.prototype.removeListener=function(a){this._listeners.splice(a,1)},f.SensorBase.prototype.onDataNotify=function(){for(var a in this._listeners){var b=this._listeners[a];b.apply(this,arguments)}},f.IRTemperature=function(a){var b="f000aa01-0451-4000-b000-000000000000",c="f000aa02-0451-4000-b000-000000000000",d="f000aa03-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.identifier="IRTemperature",this.scale=f.IRTemperature.Scale.Celcius},f.IRTemperature.UUID_SERVICE="f000aa00-0451-4000-b000-000000000000",f.IRTemperature.prototype=new f.SensorBase,f.IRTemperature.prototype.constructor=f.IRTemperature,f.IRTemperature.prototype.scaleTemperature=function(a,b){switch(b=b||this.scale){case f.IRTemperature.Scale.Farenheit:a=1.8*a+32}return a},f.IRTemperature.prototype.calculateAmbientTemperature=function(a,b){var c=new Int16Array(a),d=c[1]/128;return this.scaleTemperature(d,b)},f.IRTemperature.prototype.calculateTargetTemperature=function(a,b){var c=this.calculateAmbientTemperature(a,f.IRTemperature.Scale.Celcius),d=new Int16Array(a),e=1.5625e-7*d[0],g=c+273.15,h=5.593e-14,i=.00175,j=-1678e-8,k=-294e-7,l=-5.7e-7,m=4.63e-9,n=13.4,o=298.15,p=h*(1+i*(g-o)+j*Math.Pow(g-o,2)),q=k+l*(g-o)+m*Math.Pow(g-o,2),r=e-q+n*Math.Pow(e-q,2),s=Math.Pow(Math.Pow(g,4)+r/p,.25)-273.15;return this.scaleTemperature(s,b)},f.IRTemperature.Scale={Celcius:0,Farenheit:1},f.Accelerometer=function(a){var b="f000aa11-0451-4000-b000-000000000000",c="f000aa12-0451-4000-b000-000000000000",d="f000aa13-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.identifier="Accelerometer"},f.Accelerometer.UUID_SERVICE="f000aa10-0451-4000-b000-000000000000",f.Accelerometer.prototype=new f.SensorBase,f.Accelerometer.prototype.constructor=f.Accelerometer,f.Accelerometer.prototype.setPeriod=function(a){var b=Math.round(a/10),c=this;evothings.ble.writeCharacteristic(c.sensorTag.device,c._handles.period,new Uint8Array([b]),function(){c.log("Period set to "+a+"ms")},function(a){c.log("setPeriod error: "+a)})},f.Accelerometer.prototype.calculateAcceleration=function(a,b){var c,d=64;c=function(a){var c=b||1,e=a*c/d;return Math.round(100*e)/100};var e=new Int8Array(a);return{x:c(e[0]),y:c(e[1]),z:c(e[2])}},f.Humidity=function(a){var b="f000aa21-0451-4000-b000-000000000000",c="f000aa22-0451-4000-b000-000000000000",d="f000aa23-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.identifier="Humidity"},f.Humidity.UUID_SERVICE="f000aa20-0451-4000-b000-000000000000",f.Humidity.prototype=new f.SensorBase,f.Humidity.prototype.constructor=f.Humidity,f.Humidity.prototype.calculateHumidity=function(a){var b,c=new Uint16Array(a);return b=c[1]-c[1]%4,-6+125*(b/65535)},f.Magnetometer=function(a){var b="f000aa31-0451-4000-b000-000000000000",c="f000aa32-0451-4000-b000-000000000000",d="f000aa33-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.identifier="Magnetometer"},f.Magnetometer.UUID_SERVICE="f000aa30-0451-4000-b000-000000000000",f.Magnetometer.prototype=new f.SensorBase,f.Magnetometer.prototype.constructor=f.Magnetometer,f.Magnetometer.prototype.setPeriod=f.Accelerometer.prototype.setPeriod,f.Magnetometer.prototype.calculateCoordinates=function(a){var b,c=new Int16Array(a);return b=function(a){return a*(2e3/65536)},{x:b(c[0]),y:b(c[1]),z:b(c[2])}},f.BarometricPressure=function(a){var b="f000aa41-0451-4000-b000-000000000000",c="f000aa42-0451-4000-b000-000000000000",d="f000aa44-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.UUID_CALIBRATION="f000aa43-0451-4000-b000-000000000000",this.identifier="BarametricPressure",this.calibration=[0,0,0,0,0,0,0,0],this._handles.calibration=null},f.BarometricPressure.UUID_SERVICE="f000aa40-0451-4000-b000-000000000000",f.BarometricPressure.prototype=new f.SensorBase,f.BarometricPressure.prototype.constructor=f.BarometricPressure,f.BarometricPressure.prototype.init=function(a){for(var b in a.characteristics){var c=a.characteristics[b];switch(c.uuid){case this.UUID_CALIBRATION:this._handles.calibration=c.uuid}}f.SensorBase.prototype.init.call(this,a)},f.BarometricPressure.prototype.readCalibration=function(a,c){var d,e=this,f=2;d=function(a,d){e.log(a+" error: "+d),c!==b&&c.call(e,d)},evothings.ble.writeCharacteristic(e.sensorTag.device,e._handles.config,new Uint8Array([f]),function(){evothings.ble.readCharacteristic(e.sensorTag.device,e._handles.calibration,function(c){e.calibration=new Uint16Array(c),a!==b&&a.call(e,e.calibration)},function(a){d("readCalibration read",a)})},function(a){d("readCalibration write",a)})},f.BarometricPressure.prototype.enable=function(){this.readCalibration(SensorBase.prototype.enable)},f.BarometricPressure.prototype.calculatePressure=function(a){var b=new Int16Array(a),c=b[0],d=b[1],e=(100*(this.calibration[0]*c/Math.Pow(2,8)+this.calibration[1]*Math.Pow(2,6))/Math.Pow(2,16),this.calibration[2]+this.calibration[3]*c/Math.Pow(2,17)+this.calibration[4]*c/Math.Pow(2,15)*c/Math.Pow(2,19)),f=this.calibration[5]*Math.Pow(2,14)+this.calibration[6]*c/Math.Pow(2,3)+this.calibration[7]*c/Math.Pow(2,15)*c/Math.Pow(2,4);return(e*d+f)/Math.Pow(2,14)},f.Gyroscope=function(a){var b="f000aa51-0451-4000-b000-000000000000",c="f000aa52-0451-4000-b000-000000000000",d="f000aa53-0451-4000-b000-000000000000";f.SensorBase.prototype.constructor.call(this,a,b,c,d),this.Axis=f.Gyroscope.Axis.XYZ,this.identifier="Gyroscope"},f.Gyroscope.UUID_SERVICE="f000aa50-0451-4000-b000-000000000000",f.Gyroscope.Axis={X:1,Y:2,XY:3,Z:4,XZ:5,YZ:6,XYZ:7},f.Gyroscope.prototype=new f.SensorBase,f.Gyroscope.prototype.constructor=f.Gyroscope,f.Gyroscope.prototype.enable=function(){f.SensorBase.prototype.enable.call(this,this.Axis)},f.Gyroscope.prototype.calculateAxisValue=function(a){var b,c=new Int16Array(a);return b=function(a){var b=a*(500/65536);return Math.round(100*b)/100},{y:b(c[0]),x:b(c[1]),z:b(c[2])}},f.SimpleKey=function(){var a="0000ffe1-0000-1000-8000-00805f9b34fb";f.SensorBase.prototype.constructor.call(this,a),this.identifier="SimpleKey"},f.SimpleKey.UUID_SERVICE="0000ffe0-0000-1000-8000-00805f9b34fb",f.SimpleKey.Keys={RIGHT:1,LEFT:2,CENTER:4},f.SimpleKey.prototype=new f.SensorBase,f.SimpleKey.prototype.constructor=f.SimpleKey,delete f.SimpleKey.prototype.enable,delete f.SimpleKey.prototype.disable,a.SensorTag=f}(window);